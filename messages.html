<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Messages - CampusConnect</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    body {
      background: linear-gradient(to right, #64dfdf, #80ffdb, #72efdd, #48bfe3, #5390d9, #5e60ce);
      min-height: 100vh;
      padding-top: 120px;
      font-family: 'Poppins', sans-serif;
    }
    .message-card {
      background: #fff;
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      padding: 20px;
      margin-bottom: 15px;
      transition: transform 0.3s ease;
    }
    .message-card:hover {
      transform: translateY(-3px);
    }
    .message-card.unread {
      border-left: 5px solid #007bff;
      background: #f8f9fa;
    }
    .nav-row {
      border-bottom: 1px solid #dee2e6;
    }
    .message-badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background: #dc3545;
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
  </style>
</head>
<body class="d-flex flex-column">

  <!-- Top Navbar Row 1 -->
  <nav class="navbar navbar-light bg-light fixed-top nav-row">
    <div class="container-fluid">
      <span class="navbar-brand mb-0 h1">CampusConnect ðŸŽ“ - Messages</span>
      <div class="d-flex">
        <div class="position-relative me-3">
          <button class="btn btn-outline-primary position-relative" onclick="viewMessages()">
            <i class="fas fa-bell"></i>
            <span class="message-badge" id="messageCount">0</span>
          </button>
        </div>
        <button id="authButton" class="btn btn-outline-danger" onclick="handleAuth()">Sign Out</button>
      </div>
    </div>
  </nav>

  <!-- Top Navbar Row 2 -->
  <nav class="navbar navbar-expand-lg navbar-light bg-light fixed-top nav-row" style="top: 56px;">
    <div class="container-fluid">
      <div class="navbar-nav" id="navLinks">
        <!-- Dynamic links -->
      </div>
    </div>
  </nav>

  <div class="container">
    <h2 class="text-center mb-4 fw-bold">Your Messages</h2>
    
    <div class="d-flex justify-content-between mb-3">
      <button class="btn btn-success btn-sm" onclick="markAllAsRead()">
        <i class="fas fa-check-double"></i> Mark All as Read
      </button>
      <span class="text-muted" id="messageSummary">Loading messages...</span>
    </div>

    <div id="messagesContainer">
      <!-- Messages will be loaded here -->
    </div>

    <div class="text-center mt-4">
      <a href="index.html" class="btn btn-primary">Back to Home</a>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Check authentication
    document.addEventListener('DOMContentLoaded', function() {
      const token = localStorage.getItem('token');
      if (!token) {
        alert('Please login first');
        window.location.href = 'login.html';
        return;
      }
      updateNavbar();
      loadMessages();
      loadMessageCount();
    });

    // Navbar functionality
    function updateNavbar() {
      const token = localStorage.getItem('token');
      const userRole = localStorage.getItem('userRole');
      const authButton = document.getElementById('authButton');
      const navLinks = document.getElementById('navLinks');
      
      if (token) {
        authButton.textContent = 'Sign Out';
        authButton.className = 'btn btn-outline-danger';
        
        let adminLink = '';
        if (userRole === 'admin') {
          adminLink = '<a class="nav-link" href="admin_dashboard.html">Admin Panel</a>';
        }
        
        navLinks.innerHTML = `
          ${adminLink}
          <a class="nav-link" href="index.html">Home</a>
          <a class="nav-link" href="profile.html">View Profile</a>
          <a class="nav-link" href="orders.html">My Orders</a>
          <a class="nav-link" href="feedback.html">Feedback</a>
          <a class="nav-link" href="contact.html">Contact Us</a>
          <a class="nav-link" href="services.html">Services</a>
          <a class="nav-link" href="address.html">Address</a>
        `;
      }
    }

    function handleAuth() {
      localStorage.removeItem('token');
      localStorage.removeItem('userId');
      localStorage.removeItem('username');
      localStorage.removeItem('userRole');
      window.location.href = 'index.html';
    }

    // Load messages
    async function loadMessages() {
      try {
        const token = localStorage.getItem('token');
        const response = await fetch('http://localhost:5000/api/messages', {
          headers: {
            'Authorization': 'Bearer ' + token
          }
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Failed to load messages');
        }

        const container = $("#messagesContainer");
        container.empty();

        if (!data.messages || data.messages.length === 0) {
          container.html(`
            <div class="text-center py-5">
              <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
              <h4>No Messages</h4>
              <p class="text-muted">You don't have any messages yet.</p>
            </div>
          `);
          $("#messageSummary").text("No messages");
          return;
        }

        // Update message summary
        const unreadCount = data.messages.filter(msg => !msg.isRead).length;
        $("#messageSummary").text(`${data.messages.length} messages (${unreadCount} unread)`);

        data.messages.forEach(message => {
          const messageCard = `
            <div class="message-card ${message.isRead ? '' : 'unread'}" id="message-${message._id}">
              <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1">
                  <p class="mb-2">${message.message}</p>
                  <small class="text-muted">
                    <i class="fas fa-clock"></i> ${new Date(message.createdAt).toLocaleString()}
                    ${message.type ? ` â€¢ <span class="badge bg-secondary">${message.type.replace('_', ' ')}</span>` : ''}
                  </small>
                </div>
                ${!message.isRead ? `
                  <button class="btn btn-success btn-sm ms-3" onclick="markAsRead('${message._id}')">
                    <i class="fas fa-check"></i> Mark Read
                  </button>
                ` : `
                  <span class="badge bg-success ms-3">Read</span>
                `}
              </div>
            </div>
          `;
          container.append(messageCard);
        });

      } catch (err) {
        console.error('Error loading messages:', err);
        $("#messagesContainer").html(`
          <div class="text-center text-danger py-5">
            <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
            <h4>Failed to load messages</h4>
            <p>Please try again later</p>
          </div>
        `);
      }
    }

    // Mark single message as read
    async function markAsRead(messageId) {
      try {
        const token = localStorage.getItem('token');
        const response = await fetch(`http://localhost:5000/api/messages/${messageId}/read`, {
          method: 'PUT',
          headers: {
            'Authorization': 'Bearer ' + token
          }
        });

        if (response.ok) {
          // Update UI
          $(`#message-${messageId}`).removeClass('unread');
          $(`#message-${messageId} button`).replaceWith('<span class="badge bg-success ms-3">Read</span>');
          
          // Reload message count in navbar
          loadMessageCount();
          loadMessages(); // Reload to update summary
        }
      } catch (err) {
        console.error('Error marking message as read:', err);
        alert('Failed to mark message as read');
      }
    }

    // Mark all messages as read
    async function markAllAsRead() {
      try {
        const token = localStorage.getItem('token');
        const response = await fetch('http://localhost:5000/api/messages/mark-all-read', {
          method: 'PUT',
          headers: {
            'Authorization': 'Bearer ' + token
          }
        });

        if (response.ok) {
          alert('All messages marked as read!');
          loadMessages();
          loadMessageCount();
        }
      } catch (err) {
        console.error('Error marking all messages as read:', err);
        alert('Failed to mark all messages as read');
      }
    }

    // Load message count for navbar badge
    async function loadMessageCount() {
      try {
        const token = localStorage.getItem('token');
        const response = await fetch('http://localhost:5000/api/messages/unread-count', {
          headers: {
            'Authorization': 'Bearer ' + token
          }
        });
        
        if (response.ok) {
          const data = await response.json();
          document.getElementById('messageCount').textContent = data.count;
        }
      } catch (err) {
        console.error('Error loading message count:', err);
      }
    }

    function viewMessages() {
      // Already on messages page, just reload
      loadMessages();
      loadMessageCount();
    }

    // Load message count for navbar
async function loadMessageCount() {
  try {
    const token = localStorage.getItem('token');
    const response = await fetch('http://localhost:5000/api/messages/unread-count', {
      headers: {
        'Authorization': 'Bearer ' + token
      }
    });
    
    if (response.ok) {
      const data = await response.json();
      document.getElementById('messageCount').textContent = data.count;
    }
  } catch (err) {
    console.error('Error loading message count:', err);
  }
}

// View messages function
function viewMessages() {
  window.location.href = 'messages.html';
}
  </script>
</body>
</html>