<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Edit Admin - CampusConnect Admin</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="maincss.css">
<style>
    .edit-card {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        border-radius: var(--radius-2xl);
        box-shadow: var(--shadow-2xl);
        padding: 2.5rem;
        max-width: 600px;
        margin: 0 auto;
        border: 1px solid rgba(255, 255, 255, 0.3);
        animation: slideIn 0.8s ease-out;
    }
    .error-message {
        color: var(--danger-color);
        font-size: 0.875rem;
        margin-top: 0.25rem;
        display: none;
    }
</style>
</head>
<body class="d-flex flex-column">

  <!-- Top Navbar Row 1 -->
  <nav class="navbar navbar-light bg-light fixed-top nav-row">
    <div class="container-fluid">
      <span class="navbar-brand mb-0 h1">CampusConnect ðŸŽ“ - Edit Admin</span>
      <div class="d-flex">
        <button id="authButton" class="btn btn-outline-danger" onclick="handleAuth()">Sign Out</button>
      </div>
    </div>
  </nav>

  <!-- Custom Feedback Modal -->
  <div class="modal fade" id="feedbackModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header" id="feedbackHeader">
          <h5 class="modal-title" id="feedbackTitle">
            <i class="fas fa-info-circle me-2"></i>Notification
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="feedbackMessage">
          <!-- Message will be inserted here -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
        </div>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="edit-card">
      <h2 class="text-center mb-4">Edit Admin</h2>
      
      <form id="editAdminForm">
        <div class="mb-3">
          <label class="form-label fw-bold">Full Name</label>
          <input type="text" class="form-control" id="name" required>
          <div class="error-message" id="nameError">Name must contain only letters and spaces</div>
        </div>

        <div class="mb-3">
          <label class="form-label fw-bold">Register Number</label>
          <input type="text" class="form-control" id="regno" required>
          <div class="error-message" id="regnoError">Invalid Register Number (Format: 23BCA0001 - 23BCA1000)</div>
        </div>

        <div class="mb-3">
          <label class="form-label fw-bold">Email</label>
          <input type="email" class="form-control" id="email" required>
          <div class="error-message" id="emailError">Please enter a valid VIT student email address</div>
        </div>

        <div class="mb-3">
          <label class="form-label fw-bold">Address</label>
          <input type="text" class="form-control" id="address" required>
          <div class="error-message" id="addressError">Address is required</div>
        </div>

        <div class="mb-3">
          <label class="form-label fw-bold">Phone Number</label>
          <input type="tel" class="form-control" id="phone" required>
          <div class="error-message" id="phoneError">Phone number must be exactly 10 digits</div>
        </div>

        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
          <button type="button" class="btn btn-secondary me-md-2" onclick="cancelEdit()">Cancel</button>
          <button type="submit" class="btn btn-primary">Update Admin</button>
        </div>
      </form>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Custom feedback function
    function showFeedback(message, type = 'info') {
      const modal = new bootstrap.Modal(document.getElementById('feedbackModal'));
      const header = document.getElementById('feedbackHeader');
      const title = document.getElementById('feedbackTitle');
      const messageEl = document.getElementById('feedbackMessage');
      
      switch(type) {
        case 'success':
          header.className = 'modal-header bg-success text-white';
          title.innerHTML = '<i class="fas fa-check-circle me-2"></i>Success!';
          break;
        case 'error':
          header.className = 'modal-header bg-danger text-white';
          title.innerHTML = '<i class="fas fa-times-circle me-2"></i>Error!';
          break;
        case 'warning':
          header.className = 'modal-header bg-warning text-white';
          title.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Warning!';
          break;
        default:
          header.className = 'modal-header bg-primary text-white';
          title.innerHTML = '<i class="fas fa-info-circle me-2"></i>Information';
      }
      
      messageEl.textContent = message;
      modal.show();
    }

    let adminId = new URLSearchParams(window.location.search).get('id');

    // Check authentication and admin role
    document.addEventListener('DOMContentLoaded', function() {
      const token = localStorage.getItem('token');
      const userRole = localStorage.getItem('userRole');
      
      if (!token || userRole !== 'admin') {
        showFeedback('Access denied. Admin privileges required.', 'error', true, 'index.html');
        return;
      }
      
      if (!adminId) {
        showFeedback('Admin ID not provided', 'error', true, 'admin_data.html');
        return;
      }
      
      loadAdminData();
      setupFormValidation();
    });

    function handleAuth() {
      localStorage.removeItem('token');
      localStorage.removeItem('userId');
      localStorage.removeItem('username');
      localStorage.removeItem('userRole');
      window.location.href = 'index.html';
    }

    // Form validation setup
    function setupFormValidation() {
      // Real-time validation
      $("#name").on("input", validateName);
      $("#regno").on("input", validateRegno);
      $("#email").on("input", validateEmail);
      $("#phone").on("input", validatePhone);
      $("#address").on("input", validateAddress);
    }

    // Validation functions
    function validateName() {
      const name = $("#name").val().trim();
      const isValid = name !== "" && /^[A-Za-z\s]+$/.test(name);
      toggleError("nameError", !isValid);
      return isValid;
    }

    function validateRegno() {
      const regno = $("#regno").val().trim().toUpperCase();
      const regnoPattern = /^23BCA(0[0-9]{3}|1000)$/i;
      const isValid = regnoPattern.test(regno);
      toggleError("regnoError", !isValid);
      return isValid;
    }

    function validateEmail() {
      const email = $("#email").val().trim();
      const emailPattern = /^[A-Za-z]+\.?[A-Za-z]+[0-9]{4}@vitstudent\.ac\.in$/;
      const isValid = emailPattern.test(email);
      toggleError("emailError", !isValid);
      return isValid;
    }

    function validatePhone() {
      const phone = $("#phone").val().trim();
      const isValid = /^[0-9]{10}$/.test(phone);
      toggleError("phoneError", !isValid);
      return isValid;
    }

    function validateAddress() {
      const address = $("#address").val().trim();
      const isValid = address !== "";
      toggleError("addressError", !isValid);
      return isValid;
    }

    function toggleError(errorId, show) {
      if (show) {
        $("#" + errorId).show();
        $("#" + errorId.replace('Error', '')).addClass("is-invalid");
      } else {
        $("#" + errorId).hide();
        $("#" + errorId.replace('Error', '')).removeClass("is-invalid");
      }
    }

    function validateForm() {
      const isNameValid = validateName();
      const isRegnoValid = validateRegno();
      const isEmailValid = validateEmail();
      const isPhoneValid = validatePhone();
      const isAddressValid = validateAddress();

      return isNameValid && isRegnoValid && isEmailValid && isPhoneValid && isAddressValid;
    }

    // Load admin data
    async function loadAdminData() {
      try {
        const token = localStorage.getItem('token');
        const response = await fetch(`http://localhost:5000/api/admin/admins/${adminId}`, {
          headers: {
            'Authorization': 'Bearer ' + token
          }
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Failed to load admin data');
        }

        // Fill form with admin data
        document.getElementById('name').value = data.admin.name;
        document.getElementById('regno').value = data.admin.regno;
        document.getElementById('email').value = data.admin.email;
        document.getElementById('address').value = data.admin.address;
        document.getElementById('phone').value = data.admin.phone;

      } catch (err) {
        showFeedback('Error loading admin data: ' + err.message, 'error');
        window.location.href = 'admin_data.html';
      }
    }

    // Update admin
    $("#editAdminForm").on("submit", async function(e) {
      e.preventDefault();

      if (!validateForm()) {
        showFeedback('Please fix the validation errors before submitting.', 'warning');
        return;
      }

      const adminData = {
        name: $("#name").val().trim(),
        regno: $("#regno").val().trim().toUpperCase(),
        email: $("#email").val().trim(),
        address: $("#address").val().trim(),
        phone: $("#phone").val().trim()
      };

      try {
        const token = localStorage.getItem('token');
        const response = await fetch(`http://localhost:5000/api/admin/admins/${adminId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify(adminData)
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Failed to update admin');
        }

        showFeedback('Admin updated successfully!', 'success');
        setTimeout(() => {
          window.location.href = 'admin_data.html';
        }, 1500);

      } catch (err) {
        showFeedback('Error: ' + err.message, 'error');
      }
    });

    function cancelEdit() {
      window.location.href = 'admin_data.html';
    }
  </script>
</body>
</html>